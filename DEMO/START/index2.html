<!DOCTYPE HTML>
<html>

<head>
    <title>--第十章--</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <script src="../marked.min.js"></script>

    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']],
                processEscapes: true,
                packages: ['base', 'ams', 'physics'] // 添加需要的扩展包
            },
            svg: { fontCache: 'global' } // 使用 SVG 渲染模式
        };
    </script>

    <script src="../MathJax-master/es5/tex-mml-chtml.js"></script>

    <style>
        /*  新增的消息气泡样式  */
        .user-message-container {
            display: flex;
            justify-content: flex-end;
            /* 用户消息靠右 */
            margin-bottom: 10px;
        }

        .ai-message-container {
            display: flex;
            justify-content: flex-start;
            /* AI 消息靠左 */
            margin-bottom: 10px;
        }

        .message-bubble {
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 0.95em;
            /* 缩小气泡内字体大小 */
        }

        .user-message-container .message-bubble {
            background-color: #e0f7fa;
            /*  用户消息气泡背景色，可以调整  */
            border: 1px solid #b2ebf2;
            /*  用户消息气泡边框色，可以调整  */
            text-align: right;
            /*  消息内容右对齐  */
        }

        .ai-message-container .message-bubble {
            background-color: #f0f0f0;
            /*  AI 消息气泡背景色，可以调整  */
            border: 1px solid #d0d0d0;
            /*  AI 消息气泡边框色，可以调整  */
            text-align: left;
            /*  消息内容左对齐  */
        }

        .message-bubble strong {
            display: block;
            /*  "User:" 或 "第十章:" 独占一行  */
            margin-bottom: 5px;
            font-weight: bold;
            /*  加粗  */
        }

        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            /* 修改 height: 120% 为 min-height: 100vh，更标准 */
            font-family: '微软雅黑', sans-serif;
            /* 更现代的字体 */
            background-color: #f4f7f9;
            /* 淡雅的背景色 */
            color: #333;
            /* 默认文本颜色 */
            overflow-x: hidden;
            /* 避免水平滚动条 */
        }

        #first-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            /* 恢复 height: 100vh，强制占据整个屏幕高度 */
        }

        header.major.special {
            flex-shrink: 0;
            padding: 20px;
            background: #fff;
            /* 头部背景白色 */
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            /* 更柔和的阴影 */
            text-align: center;
            /* 标题居中 */
            border-bottom: 1px solid #eee;
            /* 底部增加细线 */
        }

        header.major.special h2 {
            font-size: 1.8em;
            /* 缩小标题字体大小 */
            font-weight: bold;
            color: #3498db;
            margin-bottom: 0.5em;
        }

        #response-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f4f7f9;
            /* 与body背景色一致 */
            display: flex;
            flex-direction: column;
            /* 确保消息从顶部到底部排列 */
            gap: 15px;
            /* 消息之间的间距 */
        }

        #response-container p {
            padding: 15px;
            border-radius: 10px;
            line-height: 1.6;
            word-wrap: break-word;
            /* 长文本自动换行 */
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
            /* 消息气泡阴影 */
        }

        #response-container p strong {
            font-weight: bold;
            color: #2c3e50;
            /* 消息来源强调色 */
        }

        #response-container p:nth-child(odd) {
            /* 奇数消息（用户消息）样式 */
            background-color: #fff;
            align-self: flex-start;
            /* 用户消息靠左 */
            border: 1px solid #e0e6ed;
            /* 边框 */
        }

        #response-container p:nth-child(even) {
            /* 偶数消息（AI回复）样式 */
            background-color: #e6f7ff;
            /* AI回复背景色 */
            align-self: flex-end;
            /* AI回复靠右 */
            border: 1px solid #a3cef1;
            /* 边框 */
        }


        #chatForm {
            flex-shrink: 0;
            background: #fff;
            padding: 15px;
            box-shadow: 0 -3px 15px rgba(0, 0, 0, 0.05);
            /* 输入框底部阴影 */
            border-top: 1px solid #eee;
            /* 顶部增加细线 */
            display: flex;
            align-items: center;
            /* 垂直居中对齐 */
        }

        #chatForm textarea {
            flex-grow: 1;
            /* 文本框自适应宽度 */
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px 15px;
            margin-right: 10px;
            /* 文本框与按钮间距 */
            font-size: 1em;
            resize: none;
            /* 禁止手动调整大小，如果需要可以改为 vertical */
            line-height: 1.5;
            overflow: auto;
            /* 内容超出时显示滚动条 */
            min-height: 40px;
            /* 最小高度 */
            max-height: 150px;
            /* 最大高度，避免输入框过高 */
        }

        #chatForm textarea:focus {
            border-color: #3498db;
            /* 聚焦时边框颜色 */
            outline: none;
            /* 去除默认 focus 样式 */
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
            /* 聚焦时增加阴影 */
        }

        #chatForm .actions {
            margin: 0;
            /* 移除默认 margin */
            list-style: none;
            /* 移除列表符号 */
            padding: 0;
            display: flex;
            gap: 10px;
            /* 按钮之间间距 */
        }

        #chatForm .actions li {
            margin: 0;
            /* 移除列表项默认 margin */
        }

        #chatForm .actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            color: white;
            background-color: #3498db;
            /* 默认按钮背景色 */
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            /* 平滑过渡效果 */
        }

        #chatForm .actions button.primary {
            background-color: #4CAF50;
            /* 主要按钮颜色，例如Send Message */
        }

        #chatForm .actions button.button {
            background-color: #f44336;
            /* 次要按钮颜色，例如Stop */
        }

        #chatForm .actions button:hover {
            opacity: 0.9;
            /* 鼠标悬停时 हल्का 透明 */
        }

        #chatForm .actions button:disabled {
            background-color: #95a5a6;
            /* 禁用状态按钮颜色 */
            cursor: not-allowed;
            /* 禁用状态鼠标样式 */
        }


        .typing-cursor {
            display: inline-block;
            width: 4px;
            /* 光标宽度 */
            background-color: #333;
            /* 光标颜色 */
            animation: blink 1s steps(5, start) infinite;
            /* 更明显的光标 */
            margin-left: 2px;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        #footer {
            text-align: center;
            padding: 20px 0;
            background-color: #e0e6ed;
            /* 页脚背景色 */
            color: #555;
            font-size: 0.9em;
        }

        #footer .icons {
            list-style: none;
            padding: 0;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            /* 图标居中 */
            gap: 20px;
        }

        #footer .icons li a {
            color: #777;
            transition: color 0.3s ease;
        }

        #footer .icons li a:hover {
            color: #3498db;
            /* 图标悬停颜色 */
        }

        #footer .copyright {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #footer .copyright li {
            display: inline-block;
            margin: 0 10px;
        }

        #footer .copyright li a {
            color: #555;
            text-decoration: none;
        }

        /* 针对noscript的样式 */
        noscript {
            text-align: center;
            padding: 20px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }

        noscript link[rel="stylesheet"] {
            display: block;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div id="first-container">
        <header class="major special">
            <h2>第十章</h2>
        </header>

        <div id="response-container">
        </div>

        <form id="chatForm">
            <div class="row gtr-uniform gtr-50">
                <div class="col-12">
                    <textarea name="demo-message" id="demo-message" placeholder="回车发送。SHIFT+回车换行" rows="2"></textarea>
                </div>
                <div class="col-12">
                    <ul class="actions">
                        <li><button type="submit" id="send-button" class="primary">Send Message</button></li>
                        <li><button type="button" id="stop-button" class="button">Stop</button></li>
                    </ul>
                </div>
            </div>
        </form>
    </div>

    <section id="footer">
        <ul class="icons">
            <li><a href="https://github.com/ChangAkira" class="icon brands alt fa-github" target="_blank"><span
                        class="label">GitHub</span></a></li>
            <li><a href="mailto://a259759666@163.com" class="icon solid alt fa-envelope"><span
                        class="label">envelope</span></a></li>
        </ul>
        <ul class="copyright">
            <li>&copy; 第十章</li>
            <li> <a href="../infos/index.html" target="_blank">团队主页</a></li>
        </ul>
    </section>

    <script src="../thetwo/assets/js/jquery.min.js"></script>
    <script src="../thetwo/assets/js/jquery.scrolly.min.js"></script>
    <script src="../thetwo/assets/js/browser.min.js"></script>
    <script src="../thetwo/assets/js/breakpoints.min.js"></script>
    <script src="../thetwo/assets/js/util.js"></script>
    <script src="../thetwo/assets/js/main.js"></script>
    <script>
        let controller = null; // 用于存储 AbortController 实例

        document.getElementById("chatForm").addEventListener("submit", async (event) => {
            event.preventDefault();
            await sendMessage(); // 调用发送消息的函数
        });

        // 监听 textarea 的 keydown 事件
        document.getElementById("demo-message").addEventListener("keydown", async (event) => {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault(); // 阻止默认的换行行为
                await sendMessage(); // 调用发送消息的函数
            }
        });

        // 发送消息的函数
        async function sendMessage() {
            const userMessage = document.getElementById("demo-message").value;
            const responseContainer = document.getElementById("response-container");
            const apiUrl = "https://api.deepseek.com/chat/completions";
            const apiKey = "sk-2bb1b37a7bcb4485bf791fd570095461"; // 替换为你的 API Key
            const sendButton = document.getElementById("send-button");
            const textarea = document.getElementById("demo-message");

            // 禁用 submit 按钮和 textarea
            sendButton.disabled = true;
            textarea.disabled = true;

            const userMessageDiv = document.createElement("div");
    userMessageDiv.classList.add("user-message-container");
    const userBubble = document.createElement("div");
    userBubble.classList.add("message-bubble");
    userBubble.innerHTML = escapeHTML(userMessage); // 去除 "User:" 前缀
    userMessageDiv.appendChild(userBubble);
    responseContainer.appendChild(userMessageDiv);


    const replyContainerDiv = document.createElement("div"); // 创建 AI 回复消息容器
    replyContainerDiv.classList.add("ai-message-container");
    const replyBubble = document.createElement("div");
    replyBubble.classList.add("message-bubble");
    replyBubble.innerHTML = `<span class="typing-cursor">|</span>`; // 去除 "第十章:" 前缀
    replyContainerDiv.appendChild(replyBubble);
    responseContainer.appendChild(replyContainerDiv);


            // 创建 AbortController 实例
            controller = new AbortController();

            try {
                const response = await fetch(apiUrl, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        stream: true, // 开启流式返回
                        messages: [{ role: "user", content: userMessage }]
                    }),
                    signal: controller.signal // 绑定 AbortController 的信号
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // 使用流式解析
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let done = false;
                let accumulatedText = ""; // 用于存储完整的回复内容

                while (!done) {
                    const { value, done: readerDone } = await reader.read();
                    done = readerDone;

                    if (value) {
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split("\n").filter(line => line.trim() !== "");

                        for (const line of lines) {
                            if (line.startsWith("data: ")) {
                                const parsedData = JSON.parse(line.slice(6)); // 去除 "data: " 前缀

                                // 如果有 delta.content，则拼接到 accumulatedText
                                if (parsedData?.choices?.[0]?.delta?.content) {
                                    accumulatedText += parsedData.choices[0].delta.content;
                                    replyBubble.innerHTML = ` ${accumulatedText}<span class="typing-cursor">|</span>`; // 更新气泡内容

                                    // 添加滚动跟随
                                    responseContainer.scrollTop = responseContainer.scrollHeight;
                                }

                                // 如果接收到 finish_reason，则结束解析
                                if (parsedData?.choices?.[0]?.finish_reason === "stop") {
                                    done = true;
                                    break;
                                }
                            }
                        }
                    }
                }

                // 流式返回完成后，移除打字光标 (最终回复，移除光标)
        replyBubble.innerHTML = `${accumulatedText}`; // 最终回复，移除光标 (去除 "第十章:")
            } catch (error) {
                if (error.name === "AbortError") {
                    replyBubble.innerHTML = `${accumulatedText}`; //  停止时也移除光标
                } else {
                    replyBubble.innerHTML = `<strong>Error:</strong> ${error.message}`;
                }
            } finally {
                // 在 finally 块中统一渲染公式和 Markdown
                MathJax.typesetPromise([responseContainer]).catch((err) => console.error(err.message));
                renderMarkdown(replyBubble); //  渲染 AI 回复气泡中的 Markdown

                // 清空输入框并重新启用 textarea 和 submit 按钮
                document.getElementById("demo-message").value = "";
                textarea.disabled = false;
                sendButton.disabled = false;

                // 重置 AbortController
                controller = null;

                responseContainer.scrollTop = responseContainer.scrollHeight;
            }
        }

        // 添加 STOP 按钮的点击事件
        document.getElementById("stop-button").addEventListener("click", () => {
            if (controller) {
                controller.abort(); // 中断 fetch 请求
            }
        });

        // 用于解析 SSE 数据的辅助函数
        function parseStreamData(data) {
            try {
                // 按行分隔并尝试解析 JSON
                const lines = data.split("\n").filter(line => line.trim() !== "");
                for (const line of lines) {
                    if (line.startsWith("data: ")) {
                        return JSON.parse(line.slice(6)); // 去除 "data: " 前缀
                    }
                }
            } catch (error) {
                console.error("解析流数据时出错：", error);
            }
            return null;
        }

        // 转义 HTML 特殊字符（排除 Markdown 语法中的特殊字符）
        function escapeHTML(str) {
            const markdownChars = ['#', '-', '*', '|', '`', '_', '[', ']', '(', ')', '!'];
            const div = document.createElement("div");
            div.innerText = str;
            let escapedText = div.innerHTML;

            // 恢复 Markdown 特殊字符
            markdownChars.forEach(char => {
                escapedText = escapedText.replace(new RegExp(`&${char.charCodeAt(0).toString()};`, 'g'), char);
            });

            return escapedText;
        }

        // 手动触发 Markdown 渲染
        function renderMarkdown(container) {
            const markdownContent = container.innerHTML;
            container.innerHTML = marked.parse(markdownContent); // 使用 marked.js 渲染 Markdown
        }
    </script>
<script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>