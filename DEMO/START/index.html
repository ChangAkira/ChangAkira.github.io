<!DOCTYPE HTML>
<html>

<head>
    <title>--第十章--</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="./icons/iconfont.css">
    <script src="../marked.min.js"></script>

    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']],
                processEscapes: true,
                packages: ['base', 'ams', 'physics'] // 添加需要的扩展包
            },
            svg: { fontCache: 'global' } // 使用 SVG 渲染模式
        };
    </script>

    <script src="../MathJax-master/es5/tex-mml-chtml.js"></script>

    <style>
        #g-pointer-1,
        #g-pointer-2 {
            pointer-events:none;
            position: absolute;
            top: 0;
            left: 0;
            width: 12px;
            height: 12px;
            background: #999;
            border-radius: 50%;
            background-color: #fff;
            mix-blend-mode: exclusion;
            z-index: 1;
        }

        #g-pointer-2 {
            width: 42px;
            height: 42px;
            background: #222;
            transition: .2s ease-out;
        }

        /*  新增的消息气泡样式   */
        .user-message-container {
            display: flex;
            justify-content: flex-end;
            /* 用户消息靠右 */
            margin-bottom: 10px;
        }

        .ai-message-container {
            display: flex;
            justify-content: flex-start;
            /* AI 消息靠左 */
            margin-bottom: 10px;
        }

        .message-bubble {
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 16px;
            /* 缩小气泡内字体大小 */
        }

        .user-message-container .message-bubble {
            background-color: #e0f7fa;
            /*   用户消息气泡背景色，可以调整    */
            border: 1px solid #b2ebf2;
            /*   用户消息气泡边框色，可以调整    */
            text-align: right;
            /*   消息内容右对齐    */
            padding: 10px 15px;
            /*  <--  确保 padding 与用户气泡一致，设置为 10px 15px  */
        }

        .ai-message-container .message-bubble {
            background-color: #f0f0f0;
            border: 1px solid #d0d0d0;
            text-align: left;
            padding: 10px 15px;
            /*  <--  确保 padding 与用户气泡一致，设置为 10px 15px  */
        }

        .footer-divider {
            border-top: 1px solid #ddd;
            /*  浅灰色分隔线 */
            margin: 15px auto;
            /*  上下外边距，并水平居中 */
            width: 80%;
            /*  分隔线宽度，可以调整 */
        }

        .message-bubble strong {
            display: block;
            /*   "User:" 或 "第十章:" 独占一行    */
            margin-bottom: 5px;
            font-weight: bold;
            /*   加粗    */
        }
        textarea,
a{

  cursor: none; /* 隐藏特定元素上的默认鼠标指针 */
}
        body {
            cursor: none;
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            /* 修改 height: 120% 为 min-height: 100vh，更标准 */
            font-family: '微软雅黑', sans-serif;
            /* 更现代的字体 */
            background-color: #f4f7f9;
            /* 淡雅的背景色 */
            color: #333;
            /* 默认文本颜色 */
            overflow-x: hidden;
            /* 避免水平滚动条 */
        }

        #first-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            /* 恢复 height: 100vh，强制占据整个屏幕高度 */
        }

        header.major.special {
            flex-shrink: 0;
            padding: 20px;
            background: #fff;
            /* 头部背景白色 */
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            /* 更柔和的阴影 */
            text-align: center;
            /* 标题居中 */
            border-bottom: 1px solid #eee;
            /* 底部增加细线 */
        }

        header.major.special h2 {
            font-size: 1.8em;
            /* 缩小标题字体大小 */
            font-weight: bold;
            color: #3498db;
            margin-bottom: 0.5em;
        }

        #response-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f4f7f9;
            /* 与body背景色一致 */
            display: flex;
            flex-direction: column;
            /* 确保消息从顶部到底部排列 */
            gap: 15px;
            /* 消息之间的间距 */
        }

        #response-container p {
            padding: 15px;
            border-radius: 5px;
            line-height: 1.6;
            word-wrap: break-word;
            /* 长文本自动换行 */
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
            /* 消息气泡阴影 */
        }

        #response-container p strong {
            font-weight: bold;
            color: #2c3e50;
            /* 消息来源强调色 */
        }


        #chatForm {
            flex-shrink: 0;
            background: #fff;
            padding: 30px;
            box-shadow: 0 -3px 15px rgba(0, 0, 0, 0.05);
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            position: relative;
            padding-right: 60px;
            /*  <-- 尝试添加或增大 padding-right 值，例如 60px  */
        }

        #chatForm textarea {
            flex-grow: 1;
            /* 文本框自适应宽度 */
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px 15px;
            margin-right: 10px;
            /* 文本框与按钮间距 (实际会被按钮绝对定位覆盖，可以考虑移除或改为 margin-left) */
            font-size: 16px;
            /*  与消息气泡字号一致 (message-bubble 的字号) */
            resize: none;
            line-height: 1.5;
            overflow: auto;
            min-height: 40px;
            max-height: 150px;
        }

        #chatForm textarea:focus {
            border-color: #3498db;
            /* 聚焦时边框颜色 */
            outline: none;
            /* 去除默认 focus 样式 */
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
            /* 聚焦时增加阴影 */
        }

        #chatForm .actions {
            
            margin: 0;
            list-style: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: absolute;
            /* bottom: 15px;  移除 bottom 属性 */
            top: 50%;
            /*  设置为 top: 50%  */
            transform: translateY(-50%);
            /*  使用 translateY(-50%) 进行垂直居中 */
            right: 15px;
        }

        #chatForm .actions li {
            margin: 0;
        }

        #chatForm .actions button {
            
            padding: 0;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            /* 修改为较小的圆角值，例如 8px */
            border: 4px solid red;
            /* 添加红色边框，粗细可以调整 */
            background-color: white;
            /* 修改为白色背景 */
            color: red;
            /* 图标颜色也改为红色，与边框统一风格 */
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #chatForm .actions button.primary {
            cursor:none;
            border-color: rgba(0, 100, 0, 0.348);
            /*  "发送" 按钮的边框颜色调整为深绿色 */
            color: darkgreen;
            /*  "发送" 按钮的图标颜色调整为深绿色 */
        }

        #chatForm .actions button.button {
            cursor:none;
            border-color: rgba(139, 0, 0, 0.351);
            /*  "停止" 按钮的边框颜色调整为深红色 */
            color: darkred;
            /*  "停止" 按钮的图标颜色调整为深红色 */
        }

        #chatForm .actions button:hover {
            background-color: rgba(255, 255, 255, 0.8);
            /*  鼠标悬停时，背景颜色略微透明 */
            opacity: 1;
            /* 移除 hover 时的 opacity 效果，保持不透明 */
        }

        #chatForm .actions button:disabled {
            background-color: rgba(0, 100, 0, 0.348);
            cursor: not-allowed;
        }


        .typing-cursor {
            display: inline-block;
            width: 4px;
            /* 光标宽度 */
            background-color: #333;
            /* 光标颜色 */
            animation: blink 1s steps(5, start) infinite;
            /* 更明显的光标 */
            margin-left: 2px;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        #footer {
            text-align: center;
            padding: 20px 0;
            background-color: #f9f9f9;
            /*  浅灰色背景，更接近图片 */
            color: #555;
            font-size: 0.9em;
        }

        #footer .icons li a span {
            color: #999;
            /*  更柔和的灰色图标颜色 */
            transition: color 0.3s ease;
            font-size: 2em;
            /*  略微缩小图标尺寸 */
        }

        #footer .icons {
            list-style: none;
            padding: 0;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            gap: 15px;
            /*  缩小图标之间的间距 */
        }

        #footer .icons li a span:hover {
            color: #3498db;
            /* 图标悬停颜色 */
        }

        #footer .copyright {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #footer .copyright li {
            display: inline-block;
            margin: 0 10px;
        }

        #footer .copyright li a {
            color: #555;
            text-decoration: none;
        }

        /* 针对noscript的样式 */
        noscript {
            text-align: center;
            padding: 20px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }

        noscript link[rel="stylesheet"] {
            display: block;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div id="g-pointer-1"></div>
    <div id="g-pointer-2"></div>
    <div id="first-container">
        <header class="major special">
            <h2>第十章</h2>
        </header>

        <div id="response-container">
        </div>

        <form id="chatForm">
            <textarea name="demo-message" id="demo-message" placeholder="回车发送。SHIFT+回车换行" rows="2"></textarea>
            <ul class="actions">
                <li><button type="submit" id="send-button" class="primary"><span
                            class="iconfont icon-paper-plane"></span></button></li>
                <li><button type="button" id="stop-button" class="button"><span
                            class="iconfont icon-stopcircle"></span></button></li>
            </ul>
        </form>
    </div>

    <section id="footer">

        <ul class="icons">
            <li><a href="https://github.com/ChangAkira"><span class="iconfont icon-github"></span></a></li>
            <li><a href="mailto://a259759666@163.com"><span class="iconfont icon-envelope"></span></a></li>
        </ul>


        <ul class="copyright">
            <li>&copy; 第十章</li>
        </ul>
    </section>


    <!-- 底部波浪开始 -->
    <div class="wiiuii_layout">
        <svg class="editorial" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
            viewBox="0 24 150 28" preserveAspectRatio="none">
            <defs>
                <path id="gentle-wave" d="M-160 44c30 0 
        58-18 88-18s
        58 18 88 18 
        58-18 88-18 
        58 18 88 18
        v44h-352z" />
            </defs>
            <g class="parallax">
                <use xlink:href="#gentle-wave" x="50" y="0" fill="#4579e2" />
                <use xlink:href="#gentle-wave" x="50" y="3" fill="#3461c1" />
                <use xlink:href="#gentle-wave" x="50" y="6" fill="#2d55aa" />
            </g>
        </svg>
    </div>
    <style type='text/css'>
        .parallax>use {
            animation: move-forever 12s linear infinite;
        }

        .parallax>use:nth-child(1) {
            animation-delay: -2s;
        }

        .parallax>use:nth-child(2) {
            animation-delay: -2s;
            animation-duration: 5s;
        }

        .parallax>use:nth-child(3) {
            animation-delay: -4s;
            animation-duration: 3s;
        }

        @keyframes move-forever {
            0% {
                transform: translate(-90px, 0%);
            }

            100% {
                transform: translate(85px, 0%);
            }
        }

        .wiiuii_layout {
            width: 100%;
            height: 40px;
            position: relative;
            overflow: hidden;
            z-index: 1;
            background: var(--footer-bg);
        }

        .editorial {
            display: block;
            width: 100%;
            height: 40px;
            margin: 0;
        }
    </style>
    <!--by：HOMIE 笔记 ffnb.top-->
    <!-- 底部波浪结束 -->


    <script src="../thetwo/assets/js/jquery.min.js"></script>
    <script src="../thetwo/assets/js/jquery.scrolly.min.js"></script>
    <script src="../thetwo/assets/js/browser.min.js"></script>
    <script src="../thetwo/assets/js/breakpoints.min.js"></script>
    <script src="../thetwo/assets/js/util.js"></script>
    <script src="../thetwo/assets/js/main.js"></script>
    <script>
        let controller = null; // 用于存储 AbortController 实例

        document.getElementById("chatForm").addEventListener("submit", async (event) => {
            event.preventDefault();
            await sendMessage(); // 调用发送消息的函数
        });

        // 监听 textarea 的 keydown 事件
        document.getElementById("demo-message").addEventListener("keydown", async (event) => {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault(); // 阻止默认的换行行为
                await sendMessage(); // 调用发送消息的函数
            }
        });

        // 发送消息的函数
        async function sendMessage() {
    const userMessage = document.getElementById("demo-message").value;
    const responseContainer = document.getElementById("response-container");
    const sendButton = document.getElementById("send-button");
    const textarea = document.getElementById("demo-message");

    sendButton.disabled = true;
    textarea.disabled = true;

    //  !!!  用户消息气泡显示代码  !!!
    const userMessageDiv = document.createElement("div");
    userMessageDiv.classList.add("user-message-container");
    const userBubble = document.createElement("div");
    userBubble.classList.add("message-bubble");
    userBubble.innerHTML = escapeHTML(userMessage); //  确保 escapeHTML 函数存在且正确
    userMessageDiv.appendChild(userBubble);
    responseContainer.appendChild(userMessageDiv);
    //  !!!  用户消息气泡显示代码  !!!

    const replyContainerDiv = document.createElement("div");
    replyContainerDiv.classList.add("ai-message-container");
    const replyBubble = document.createElement("div");
    replyBubble.classList.add("message-bubble");
    replyBubble.innerHTML = `<span class="typing-cursor">|</span>`;
    replyContainerDiv.appendChild(replyBubble);
    responseContainer.appendChild(replyContainerDiv);

    controller = new AbortController();

    try {
        const response = await fetch('/api/chat', {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ message: userMessage }),
            signal: controller.signal
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        //  !!!  使用 ReadableStream 读取流式响应，并解析 SSE 数据 !!!
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let aiReplyText = "";

        while (true) {
        const { done, value } = await reader.read();
        if (done) {
            console.log("Stream finished");
            break;
        }
        const textChunk = decoder.decode(value, { stream: true });
        const lines = textChunk.split('\n\n').filter(line => line.startsWith("data: "));
        for (const line of lines) {
            //  !!!  处理双重 "data: data: " 前缀 !!!
            let jsonString = line; // 默认jsonString为原始行
            if (line.startsWith("data: data: ")) { // 检查是否以 "data: data: " 开头
                jsonString = line.substring(12); // 如果是，去除前 12 个字符 ("data: data: ")
            } else if (line.startsWith("data: ")) { // 兼容处理，如果只是以 "data: " 开头 (理论上不应出现双重前缀，但作为备选)
                jsonString = line.substring(6); // 如果只是 "data: " 开头，去除前 6 个字符 ("data: ")
            }


            //  !!!  日志 (保留，方便调试) !!!
            console.log("原始 SSE 数据行 (substring 前):", line);
            console.log("substring 处理后的 JSON 字符串:", jsonString);


            if (jsonString === "[DONE]") {
                console.log("SSE stream done signal received");
                reader.cancel();
                return;
            }
            try {
                const jsonData = JSON.parse(jsonString);
                if (jsonData?.choices?.[0]?.delta?.content) {
                    const contentChunk = jsonData.choices[0].delta.content;
                    aiReplyText += contentChunk;
                    replyBubble.innerHTML = aiReplyText + `<span class="typing-cursor">|</span>`;
                    MathJax.typesetPromise([replyBubble]).catch((err) => console.error(err.message));
                    renderMarkdown(replyBubble);
                    responseContainer.scrollTop = responseContainer.scrollHeight;
                }
            } catch (error) {
                console.error("JSON 解析错误:", error, "原始数据:", jsonString);
            }
            }
        }
        //  !!!  循环结束后，移除 typing cursor，并最终设置回复内容 !!!
        replyBubble.innerHTML = aiReplyText;
        MathJax.typesetPromise([replyBubble]).catch((err) => console.error(err.message));
        renderMarkdown(replyBubble);


    } catch (error) {
        if (error.name === "AbortError") {
            replyBubble.innerHTML = `请求已停止`;
        } else {
            replyBubble.innerHTML = `<strong>Error:</strong> ${error.message}`;
        }
    } finally {
        sendButton.disabled = false;
        textarea.disabled = false;
        textarea.value = "";
        responseContainer.scrollTop = responseContainer.scrollHeight;
        controller = null;
    }
}

        // 添加 STOP 按钮的点击事件
        document.getElementById("stop-button").addEventListener("click", () => {
            if (controller) {
                controller.abort(); // 中断 fetch 请求
            }
        });

        // 用于解析 SSE 数据的辅助函数 (可以移除，代码中已不再直接使用 parseStreamData 函数)
        function parseStreamData(data) {
            try {
                // 按行分隔并尝试解析 JSON
                const lines = data.split("\n").filter(line => line.trim() !== "");
                for (const line of lines) {
                    if (line.startsWith("data: ")) {
                        return JSON.parse(line.slice(6)); // 去除 "data: " 前缀
                    }
                }
            } catch (error) {
                console.error("解析流数据时出错：", error);
            }
            return null;
        }

        // 转义 HTML 特殊字符（排除 Markdown 语法中的特殊字符）
        function escapeHTML(str) {
            const markdownChars = ['#', '-', '*', '|', '`', '_', '[', ']', '(', ')', '!'];
            const div = document.createElement("div");
            div.innerText = str;
            let escapedText = div.innerHTML;

            // 恢复 Markdown 特殊字符
            markdownChars.forEach(char => {
                escapedText = escapedText.replace(new RegExp(`&${char.charCodeAt(0).toString()};`, 'g'), char);
            });

            return escapedText;
        }

        // 手动触发 Markdown 渲染
        function renderMarkdown(container) {
            const markdownContent = container.innerHTML;
            container.innerHTML = marked.parse(markdownContent); // 使用 marked.js 渲染 Markdown
        }
    </script>

<script>
    const body = document.querySelector("body");
    const element = document.getElementById("g-pointer-1");
    const element2 = document.getElementById("g-pointer-2");
    const halfAlementWidth = element.offsetWidth / 2;
    const halfAlementWidth2 = element2.offsetWidth / 2;

    function setPosition(x, y) {
        // 获取垂直滚动偏移量
        const scrollY = window.scrollY;

        // 在 y 坐标中减去滚动偏移量，以修正指针位置
        element.style.transform = `translate(${x - halfAlementWidth}px, ${y - halfAlementWidth + scrollY}px)`;
        element2.style.transform = `translate(${x - halfAlementWidth2}px, ${y - halfAlementWidth2 + scrollY}px)`;
    }

    body.addEventListener('mousemove', (e) => {
        window.requestAnimationFrame(function () {
            setPosition(e.clientX, e.clientY);
        });
    });
</script>

<script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>