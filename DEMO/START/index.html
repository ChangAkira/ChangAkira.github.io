<!DOCTYPE HTML><html><head><title>--第十章--</title><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1, user-scalable=no"><link rel=stylesheet href=../thetwo/assets/css/main.css><noscript><link rel=stylesheet href=../thetwo/assets/css/noscript.css></noscript><script src=https://cdn.jsdelivr.net/npm/marked/marked.min.js></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 120%;
            margin: 0;
        }

        /* 第一个容器：H2、消息记录、FORM */
        #first-container {
            height: 100vh;
            /* 占据视口的全部高度 */
            display: flex;
            flex-direction: column;
        }

        /* H2 标题 */
        header.major.special {
            flex-shrink: 0;
            /* 防止标题被压缩 */
            padding: 20px;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* 消息记录部分 */
        #response-container {
            flex: 1;
            overflow-y: auto;
            /* 消息记录可以滚动 */
            height: 100%;
            padding: 20px;
        }

        /* FORM 输入框 */
        #chatForm {
            flex-shrink: 0;
            /* 防止输入框被压缩 */
            background: white;
            padding: 10px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        .typing-cursor {
    display: inline-block;
    width: 1px;
    background-color: black;
    animation: blink 1s steps(2, start) infinite;
}

@keyframes blink {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0;
    }
}
    </style></head><body><div id=first-container><header class="major special"><h2>对话</h2></header><div id=response-container></div><form id=chatForm><div class="row gtr-uniform gtr-50"><div class=col-12><textarea name=demo-message id=demo-message placeholder=回车发送。SHIFT+回车换行 rows=2></textarea></div><div class=col-12><ul class=actions><li><button type=submit id=send-button class=primary>Send Message</button></li><li><button type=button id=stop-button class=button>Stop</button></li></ul></div></div></form></div><section id=footer><ul class=icons><li><a href=https://github.com/ChangAkira class="icon brands alt fa-github" target=_blank><span class=label>GitHub</span></a></li><li><a href=mailto://a259759666@163.com class="icon solid alt fa-envelope"><span class=label>envelope</span></a></li></ul><ul class=copyright><li>&copy; 第十章</li><li><a href=../infos/index.html target=_blank>团队主页</a></li></ul></section><script src=../thetwo/assets/js/jquery.min.js></script><script src=../thetwo/assets/js/jquery.scrolly.min.js></script><script src=../thetwo/assets/js/browser.min.js></script><script src=../thetwo/assets/js/breakpoints.min.js></script><script src=../thetwo/assets/js/util.js></script><script src=../thetwo/assets/js/main.js></script><script>
let controller = null; // 用于存储 AbortController 实例

document.getElementById("chatForm").addEventListener("submit", async (event) => {
    event.preventDefault();
    await sendMessage(); // 调用发送消息的函数
});

// 监听 textarea 的 keydown 事件
document.getElementById("demo-message").addEventListener("keydown", async (event) => {
    if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault(); // 阻止默认的换行行为
        await sendMessage(); // 调用发送消息的函数
    }
});

// 发送消息的函数
async function sendMessage() {
    const userMessage = document.getElementById("demo-message").value;
    const responseContainer = document.getElementById("response-container");
    const apiUrl = "https://api.deepseek.com/chat/completions";
    const apiKey = "sk-2bb1b37a7bcb4485bf791fd570095461"; // 替换为你的 API Key
    const sendButton = document.getElementById("send-button");
    const textarea = document.getElementById("demo-message");

    // 禁用 submit 按钮和 textarea
    sendButton.disabled = true;
    textarea.disabled = true;

    // 显示用户输入的消息
    responseContainer.innerHTML += `<p><strong>User:</strong> ${escapeHTML(userMessage)}</p>`;
    const replyContainer = document.createElement("p");
    replyContainer.innerHTML = `<strong>第十章:</strong> `;
    responseContainer.appendChild(replyContainer);

    // 创建 AbortController 实例
    controller = new AbortController();

    try {
        const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${apiKey}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                model: "deepseek-chat",
                stream: true, // 开启流式返回
                messages: [{ role: "user", content: userMessage }]
            }),
            signal: controller.signal // 绑定 AbortController 的信号
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        // 使用流式解析
        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let done = false;
        let accumulatedText = ""; // 用于存储完整的回复内容

        while (!done) {
            const { value, done: readerDone } = await reader.read();
            done = readerDone;

            if (value) {
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split("\n").filter(line => line.trim() !== "");

                for (const line of lines) {
                    if (line.startsWith("data: ")) {
                        const parsedData = JSON.parse(line.slice(6)); // 去除 "data: " 前缀

                        // 如果有 delta.content，则拼接到 accumulatedText
                        if (parsedData?.choices?.[0]?.delta?.content) {
                            accumulatedText += parsedData.choices[0].delta.content;
                            replyContainer.innerHTML = `<strong>第十章:</strong> ${accumulatedText}<span class="typing-cursor">|</span>`;
                            
                            // 添加滚动跟随
                            responseContainer.scrollTop = responseContainer.scrollHeight;
                        }

                        // 如果接收到 finish_reason，则结束解析
                        if (parsedData?.choices?.[0]?.finish_reason === "stop") {
                            done = true;
                            break;
                        }
                    }
                }
            }
        }

        // 流式返回完成后，移除打字光标
        replyContainer.innerHTML = `<strong>第十章:</strong> ${accumulatedText}`;
    } catch (error) {
        if (error.name === "AbortError") {
            replyContainer.innerHTML = `<strong>第十章:</strong> ${accumulatedText}`;
        } else {
            replyContainer.innerHTML = `<strong>Error:</strong> ${error.message}`;
        }
    } finally {
        // 在 finally 块中统一渲染公式和 Markdown
        MathJax.typesetPromise([responseContainer]).catch((err) => console.error(err.message));
        renderMarkdown(replyContainer);

        // 清空输入框并重新启用 textarea 和 submit 按钮
        document.getElementById("demo-message").value = "";
        textarea.disabled = false;
        sendButton.disabled = false;

        // 重置 AbortController
        controller = null;

        responseContainer.scrollTop = responseContainer.scrollHeight;
    }
}

// 添加 STOP 按钮的点击事件
document.getElementById("stop-button").addEventListener("click", () => {
    if (controller) {
        controller.abort(); // 中断 fetch 请求

        // 重新启用 submit 按钮和 textarea
        const sendButton = document.getElementById("send-button");
        const textarea = document.getElementById("demo-message");
        sendButton.disabled = false;
        textarea.disabled = false;
    }
});

// 用于解析 SSE 数据的辅助函数
function parseStreamData(data) {
    try {
        // 按行分隔并尝试解析 JSON
        const lines = data.split("\n").filter(line => line.trim() !== "");
        for (const line of lines) {
            if (line.startsWith("data: ")) {
                return JSON.parse(line.slice(6)); // 去除 "data: " 前缀
            }
        }
    } catch (error) {
        console.error("解析流数据时出错：", error);
    }
    return null;
}

// 转义 HTML 特殊字符（排除 Markdown 语法中的特殊字符）
function escapeHTML(str) {
    const markdownChars = ['#', '-', '*', '|', '`', '_', '[', ']', '(', ')', '!'];
    const div = document.createElement("div");
    div.innerText = str;
    let escapedText = div.innerHTML;

    // 恢复 Markdown 特殊字符
    markdownChars.forEach(char => {
        escapedText = escapedText.replace(new RegExp(`&${char.charCodeAt(0).toString()};`, 'g'), char);
    });

    return escapedText;
}

// 手动触发 Markdown 渲染
function renderMarkdown(container) {
    const markdownContent = container.innerHTML;
    container.innerHTML = marked.parse(markdownContent); // 使用 marked.js 渲染 Markdown
}
    </script><script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>